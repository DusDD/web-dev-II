<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Convo Chat</title>
    <link rel="stylesheet" href="style/jquery-ui.css">
</head>
<body>
<h1>Convo Chats</h1>

<div id="chats">
    <h2>chats:</h2>

    <label for="new-chat-input">
        User Search:
        <input type="text" name="new-chat" id="new-chat-input" placeholder="Search for a user...">
        <button id="new-chat-button">Start chat</button>
    </label>

    <ul id="chat-list">
        <!-- chat list will be populated here -->
    </ul>
</div>

<div id="chat-box">
    <!-- Messages will be displayed here -->
</div>

<form id="message-form">
    <input type="text" name="message" id="message-input" placeholder="Type your message...">
    <button type="submit">Send</button>
</form>

<script src="scripts/jquery-3.7.1.js"></script>
<script src="scripts/jquery-ui.js"></script>
<script>

    function loadChats() {
        $.ajax({
            url: 'load_chats.php',
            type: 'GET',
            success: function (data) {
                // save current selected chat
                const selectedChatId = $("#chat-box .selected").attr("data-chat-id");

                // overwrite current html with the new data
                $('#chat-list').html(data);

                // reselect the chat that was previously selected
                let hasSelection = false;
                if (selectedChatId !== undefined) {
                    let newSelectedChat = $(`.chat[data-chat-id=${selectedChatId}]`)[0];
                    if (newSelectedChat !== undefined) {
                        newSelectedChat.classList.add("selected");
                        hasSelection = true;
                    }
                }

                // if no chat is/was selected, select the first if it exists
                let firstChat = $('#chat-list li:first');
                if (!hasSelection && firstChat.length !== 0) {
                    // Load messages for the first chat by default
                    firstChat.addClass("selected");
                    loadMessages(firstChat.attr('data-chat-id'));
                }
            }
        });
    }

    function loadMessages(chatId) {
        $.ajax({
            url: 'load_messages.php',
            type: 'GET',
            data: {chat_id: chatId},
            success: function (data) {
                $('#chat-box').html(data);
            }
        });
    }

    function startChat(_ev) {
        const username = $("#new-chat-input").val().trim();
        if (username.length === 0) return;
        console.debug(`starting chat with ${username}`);
        $.ajax({
            url: "start_chat.php",
            type: "POST",
            data: {username},
            success: function (data) {
                console.debug(`created chat with ${username}`);
                loadChats();
            }
        });
    }

    function sendMessage(ev) {
        ev.preventDefault();
        const message = $('#message-input').val();
        $.ajax({
            url: 'send_message.php',
            type: 'POST',
            data: {message: message},
            success: function () {
                // clear message field
                $('#message-input').val('');
                // reload messages
                loadMessages($('#chat-list .selected').attr('data-chat-id'));
            }
        });
    }

    $(document).ready(function () {
        // Load chats on page load
        loadChats();

        // Change chat selection when user clicks on a chat
        $("#chat-list .chat").on("click", _ev => {
            // Deselect previously selected chat and select the clicked chat
            $("#chat-list .selected").classList.remove("selected");
            $(this).classList.add("selected");

            // Load messages for selected chat
            const chatId = $(this).attr('data-chat-id');
            loadMessages(chatId)
        });

        // Make new chat button create a new chat
        $("#new-chat-button").on("click", startChat);

        // Send message if user submits a new message
        $('#message-form').submit(sendMessage);



        // Completion functionality on user search
        $("#new-chat-input").autocomplete({
            source: function (request, response) {
                console.debug(`completing ${request.term}`);
                $.ajax({
                    url: "autocomplete_username.php",
                    dataType: "json",
                    data: {
                        search_string: request.term
                    },
                    success: function (data) {
                        console.debug(`completions=${data}`);
                        response(data);
                    }
                });
            },
            minLength: 2 // Minimum characters before autocomplete starts
        });

        // Refresh messages every 5 seconds
        setInterval(function () {
            loadChats();
            loadMessages($('#chat-list .selected').attr('data-chat-id'));
        }, 5000);
    });
</script>
</body>
</html>